<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .loading {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="status" class="loading">
            <h2>Processing OAuth callback...</h2>
            <p>Please wait while we complete your authentication.</p>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type');
        const provider = urlParams.get('provider');
        const data = urlParams.get('data');
        const error = urlParams.get('error');

        // Send message to parent window
        function sendMessageToParent(message) {
            if (window.opener) {
                window.opener.postMessage(message, window.location.origin);
                window.close();
            } else {
                console.error('No parent window found');
                document.getElementById('status').innerHTML = '<div class="error"><h2>Error</h2><p>No parent window found. Please close this window and try again.</p></div>';
            }
        }

        // Handle the callback
        if (type === 'OAUTH_SUCCESS' && provider && data) {
            try {
                const authData = JSON.parse(decodeURIComponent(data));
                sendMessageToParent({
                    type: 'OAUTH_SUCCESS',
                    provider: provider,
                    authData: authData
                });
            } catch (e) {
                console.error('Error parsing auth data:', e);
                sendMessageToParent({
                    type: 'OAUTH_ERROR',
                    provider: provider,
                    error: 'Failed to parse authentication data'
                });
            }
        } else if (type === 'OAUTH_ERROR' && provider && error) {
            sendMessageToParent({
                type: 'OAUTH_ERROR',
                provider: provider,
                error: decodeURIComponent(error)
            });
        } else {
            console.error('Invalid OAuth callback parameters:', { type, provider, data, error });
            sendMessageToParent({
                type: 'OAUTH_ERROR',
                provider: provider || 'unknown',
                error: 'Invalid OAuth callback parameters'
            });
        }
    </script>
</body>
</html>
